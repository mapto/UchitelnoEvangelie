from typing import List

from model import Index, LangSemantics
from processor import _close, _present, _grouped


def _equal(a: List[List[str]], b: List[List[str]]) -> bool:
    if len(a) != len(b):
        return False
    for r in range(len(a)):
        if len(a[r]) != len(b[r]):
            return False
        for c in range(len(a[r])):
            if a[r][c] != b[r][c]:
                return False
    return True


def test_grouped():
    sem = LangSemantics(
        lang="gr",
        word=10,
        lemmas=[11, 12, 13],
        var=LangSemantics(lang="gr_var", word=15, lemmas=[16, 17, 19], var=None),
    )
    row = [
        "\ue201л\ue205ко WH",
        "\ue201л\ue205къ",
        "",
        "1/7c12",
        "сел\ue205ко",
        "въ сел\ue205ко",
        "сел\ue205къ",
        "",
        "",
        "",
        "τοῦτο",
        "οὗτος",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "hl04|hl00|hl10",
    ]
    assert _grouped(row, sem)

    sem = LangSemantics(
        lang="sl",
        word=4,
        lemmas=[6, 7, 8, 9],
        var=LangSemantics(lang="sl_var", word=0, lemmas=[1, 2, 19, 20], var=None),
    )
    row = [
        "",
        "",
        "",
        "1/7d1",
        "насъ",
        "оу насъ",
        "мꙑ",
        "",
        "",
        "",
        "om.",
        "om.",
        "",
        "",
        "",
        "ἡμῖν",
        "ἡμεῖς",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
    ]
    assert not _grouped(row, sem)
    row = [
        "вѣроу GH",
        "вѣра",
        "вѣрѫ ѩт\ue205",
        "1/7b19",
        "вѣроують",
        "вьс\ue205 вѣроують",
        "вѣроват\ue205",
        "",
        "",
        "",
        "πιστεύσωσι",
        "πιστεύω",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "hl00",
    ]
    assert _grouped(row, sem)
    row = [
        "\ue205моуть GH",
        "ѩт\ue205",
        "",
        "1/7b19",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "hl00",
    ]
    assert _grouped(row, sem)


def test_present():
    sem = LangSemantics(lang="sl_var", word=0, lemmas=[1, 2, 19, 20], var=None)
    row = [
        "вѣроу GH",
        "вѣра",
        "вѣрѫ ѩт\ue205",
        "1/7b19",
        "вѣроують",
        "вьс\ue205 вѣроують",
        "вѣроват\ue205",
        "",
        "",
        "",
        "πιστεύσωσι",
        "πιστεύω",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "hl00",
    ]
    assert _present(row, sem)
    row = [
        "\ue205моуть GH",
        "ѩт\ue205",
        "",
        "1/7b19",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "hl00",
    ]
    assert _present(row, sem)
    row = [
        "\ue205моуть GH",
        "",
        "",
        "1/7b19",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "hl00",
    ]
    assert not _present(row, sem)

    sem = LangSemantics(lang="gr_var", word=15, lemmas=[16, 17, 19], var=None)
    row = [
        "вѣроу GH",
        "вѣра",
        "вѣрѫ ѩт\ue205",
        "1/7b19",
        "вѣроують",
        "вьс\ue205 вѣроують",
        "вѣроват\ue205",
        "",
        "",
        "",
        "πιστεύσωσι",
        "πιστεύω",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "hl00",
    ]
    assert not _present(row, sem)
    row = [
        "\ue205моуть GH",
        "ѩт\ue205",
        "",
        "1/7b19",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "hl00",
    ]
    assert not _present(row, sem)


def test_close():
    sl_sem = LangSemantics(
        lang="sl",
        word=4,
        lemmas=[6, 7, 8, 9],
        var=LangSemantics(lang="sl_var", word=0, lemmas=[1, 2, 19, 20], var=None),
    )
    gr_sem = LangSemantics(
        lang="gr",
        word=10,
        lemmas=[11, 12, 13],
        var=LangSemantics(lang="gr_var", word=15, lemmas=[16, 17, 19], var=None),
    )
    group = [
        [
            "все WH",
            "вьсь",
            "",
            "1/7c12",
            "въ",
            "въ сел\ue205ко",
            "въ",
            "въ + Acc.",
            "",
            "",
            "εἰς",
            "εἰς",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04|hl00|hl10",
        ],
        [
            "\ue201л\ue205ко WH",
            "\ue201л\ue205къ",
            "",
            "1/7c12",
            "сел\ue205ко",
            "въ сел\ue205ко",
            "сел\ue205къ",
            "",
            "",
            "",
            "τοῦτο",
            "οὗτος",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04|hl00|hl10",
        ],
    ]
    res = _close(group, gr_sem, sl_sem)
    expected = [
        [
            "все WH \ue201л\ue205ко WH",
            "вьсь & \ue201л\ue205къ",
            "",
            "01/007c12",
            "въ сел\ue205ко",
            "въ сел\ue205ко",
            "въ & сел\ue205къ",
            "въ + Acc.",
            "",
            "",
            "εἰς τοῦτο",
            "εἰς",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04|hl00|hl10",
        ],
        [
            "все WH \ue201л\ue205ко WH",
            "вьсь & \ue201л\ue205къ",
            "",
            "01/007c12",
            "въ сел\ue205ко",
            "въ сел\ue205ко",
            "въ & сел\ue205къ",
            "въ + Acc.",
            "",
            "",
            "εἰς τοῦτο",
            "οὗτος",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04|hl00|hl10",
        ],
    ]

    group = [
        [
            "",
            "",
            "",
            "1/5a10",
            "беꙁ",
            "ꙗвѣ• \ue205 беꙁ вѣдѣн\ue205ꙗ",
            "беꙁ ",
            "беꙁ вѣдѣн\ue205ꙗ",
            "",
            "",
            "ἀπείρως",
            "ἀπείρως",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04|hl10",
        ],
        [
            "",
            "",
            "",
            "1/5a10",
            "вѣдѣн\ue205ꙗ",
            "ꙗвѣ• \ue205 беꙁ вѣдѣн\ue205ꙗ",
            "вѣдѣн\ue205\ue201",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04|hl10",
        ],
    ]
    res = _close(group, sl_sem, gr_sem)
    expected = [
        [
            "",
            "",
            "",
            "01/005a10",
            "беꙁ вѣдѣн\ue205ꙗ",
            "ꙗвѣ• \ue205 беꙁ вѣдѣн\ue205ꙗ",
            "беꙁ ",
            "беꙁ вѣдѣн\ue205ꙗ",
            "",
            "",
            "ἀπείρως",
            "ἀπείρως",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04|hl10",
        ],
        [
            "",
            "",
            "",
            "01/005a10",
            "беꙁ вѣдѣн\ue205ꙗ",
            "ꙗвѣ• \ue205 беꙁ вѣдѣн\ue205ꙗ",
            "вѣдѣн\ue205\ue201",
            "беꙁ вѣдѣн\ue205ꙗ",
            "",
            "",
            "ἀπείρως",
            "ἀπείρως",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04|hl10",
        ],
    ]
    assert _equal(res, expected)

    group = [
        [
            "все WH",
            "вьсь",
            "",
            "1/7c12",
            "въ",
            "въ сел\ue205ко",
            "въ",
            "въ + Acc.",
            "",
            "",
            "εἰς",
            "εἰς",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04|hl00|hl07|hl10",
        ],
        [
            "\ue201л\ue205ко WH",
            "\ue201л\ue205къ",
            "",
            "1/7c12",
            "сел\ue205ко",
            "въ сел\ue205ко",
            "сел\ue205къ",
            "",
            "",
            "",
            "τοῦτο",
            "οὗτος",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04|hl00|hl10",
        ],
    ]
    res = _close(group, gr_sem, sl_sem)
    expected = [
        [
            "все WH \ue201л\ue205ко WH",
            "вьсь & \ue201л\ue205къ",
            "",
            "01/007c12",
            "въ сел\ue205ко",
            "въ сел\ue205ко",
            "въ & сел\ue205къ",
            "въ + Acc.",
            "",
            "",
            "εἰς τοῦτο",
            "εἰς",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04|hl00|hl07|hl10",
        ],
        [
            "все WH \ue201л\ue205ко WH",
            "вьсь & \ue201л\ue205къ",
            "",
            "01/007c12",
            "въ сел\ue205ко",
            "въ сел\ue205ко",
            "въ & сел\ue205къ",
            "въ + Acc.",
            "",
            "",
            "εἰς τοῦτο",
            "οὗτος",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04|hl00|hl10",
        ],
    ]
    assert _equal(res, expected)

    group = [
        [
            "",
            "",
            "",
            "1/5a16",
            "ꙁан\ue201",
            "еще же \ue205 ꙁан\ue201 въꙁвѣст\ue205лъ",
            "ꙁан\ue201",
            "",
            "",
            "",
            "διὰ",
            "διά ",
            "διά + Acc.",
            "διὰ τό",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04|hl10|hl12",
        ],
        [
            "",
            "",
            "",
            "1/5a16",
            "",
            "",
            "",
            "",
            "",
            "",
            "τὸ",
            "ὁ",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04|hl10",
        ],
    ]
    res = _close(group, gr_sem, sl_sem)
    expected = [
        [
            "",
            "",
            "",
            "01/005a16",
            "ꙁан\ue201",
            "еще же \ue205 ꙁан\ue201 въꙁвѣст\ue205лъ",
            "ꙁан\ue201",
            "",
            "",
            "",
            "διὰ τὸ",
            "διά ",
            "διά + Acc.",
            "διὰ τό",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04|hl10|hl12",
        ],
        [
            "",
            "",
            "",
            "01/005a16",
            "ꙁан\ue201",
            "",
            "ꙁан\ue201",
            "",
            "",
            "",
            "διὰ τὸ",
            "ὁ",
            "",
            "διὰ τό",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04|hl10",
        ],
    ]
    assert _equal(res, expected)

    group = [
        [
            "все WH",
            "вьсь",
            "",
            "1/7c12",
            "въ",
            "въ сел\ue205ко",
            "въ",
            "въ + Acc.",
            "",
            "",
            "εἰς",
            "εἰς",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04|hl00|hl07|hl10",
        ],
        [
            "\ue201л\ue205ко WH",
            "\ue201л\ue205къ",
            "",
            "1/7c12",
            "сел\ue205ко",
            "въ сел\ue205ко",
            "сел\ue205къ",
            "",
            "",
            "",
            "τοῦτο",
            "οὗτος",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04|hl00|hl10",
        ],
    ]
    res = _close(group, sl_sem, gr_sem)
    expected = [
        [
            "все WH \ue201л\ue205ко WH",
            "вьсь",
            "",
            "01/007c12",
            "въ сел\ue205ко",
            "въ сел\ue205ко",
            "въ",
            "въ + Acc.",
            "",
            "",
            "εἰς τοῦτο",
            "εἰς & οὗτος",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04|hl00|hl07|hl10",
        ],
        [
            "все WH \ue201л\ue205ко WH",
            "\ue201л\ue205къ",
            "",
            "01/007c12",
            "въ сел\ue205ко",
            "въ сел\ue205ко",
            "сел\ue205къ",
            "",
            "",
            "",
            "εἰς τοῦτο",
            "εἰς & οὗτος",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04|hl00|hl10",
        ],
    ]
    assert _equal(res, expected)

    group = [
        [
            "\ue205л\ue205 WH",
            "\ue205л\ue205",
            "",
            "1/6a11",
            "л\ue205 ",
            "\ue201сть л\ue205 раꙁѹмьно",
            "л\ue205 ",
            "",
            "",
            "",
            "κἂν",
            "καί",
            "κἄν",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl10",
        ],
        [
            "",
            "",
            "",
            "1/6a11",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "ἀν",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl10",
        ],
    ]
    res = _close(group, sl_sem, gr_sem)
    expected = [
        [
            "\ue205л\ue205 WH",
            "\ue205л\ue205",
            "",
            "01/006a11",
            "л\ue205 ",
            "\ue201сть л\ue205 раꙁѹмьно",
            "л\ue205 ",
            "",
            "",
            "",
            "κἂν",
            "καί & ἀν",
            "κἄν",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl10",
        ],
        [
            "\ue205л\ue205 WH",
            "",
            "",
            "01/006a11",
            "л\ue205 ",
            "",
            "",
            "",
            "",
            "",
            "κἂν",
            "καί & ἀν",
            "κἄν",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl10",
        ],
    ]
    assert _equal(res, expected)

    group = [
        [
            "\ue205л\ue205 WH",
            "\ue205л\ue205",
            "",
            "1/6a11",
            "л\ue205 ",
            "\ue201сть л\ue205 раꙁѹмьно",
            "л\ue205 ",
            "",
            "",
            "",
            "κἂν",
            "καί",
            "κἄν",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl10",
        ],
        [
            "",
            "",
            "",
            "1/6a11",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "ἀν",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl10",
        ],
    ]
    res = _close(group, gr_sem, sl_sem)
    expected = [
        [
            "\ue205л\ue205 WH",
            "\ue205л\ue205",
            "",
            "01/006a11",
            "л\ue205 ",
            "\ue201сть л\ue205 раꙁѹмьно",
            "л\ue205 ",
            "",
            "",
            "",
            "κἂν",
            "καί",
            "κἄν",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl10",
        ],
        [
            "\ue205л\ue205 WH",
            "\ue205л\ue205",
            "",
            "01/006a11",
            "л\ue205 ",
            "",
            "л\ue205 ",
            "",
            "",
            "",
            "κἂν",
            "ἀν",
            "κἄν",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl10",
        ],
    ]
    assert _equal(res, expected)

    group = [
        [
            "",
            "",
            "",
            "1/6a10",
            "тѣмь",
            "тѣмь л\ue205 в\ue205д\ue205мо",
            "тѣмь",
            "тѣмь л\ue205",
            "",
            "",
            "κἂν",
            "καί",
            "κἄν",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04",
        ],
        [
            "\ue205л\ue205 WH",
            "\ue205л\ue205",
            "",
            "1/6a10",
            "л\ue205",
            "тѣмь л\ue205 в\ue205д\ue205мо",
            "л\ue205",
            "",
            "",
            "",
            "",
            "ἀν",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04",
        ],
    ]
    res = _close(group, sl_sem, gr_sem)
    expected = [
        [
            "\ue205л\ue205 WH",
            "",
            "",
            "01/006a10",
            "тѣмь л\ue205",
            "тѣмь л\ue205 в\ue205д\ue205мо",
            "тѣмь",
            "тѣмь л\ue205",
            "",
            "",
            "κἂν",
            "καί & ἀν",
            "κἄν",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04",
        ],
        [
            "\ue205л\ue205 WH",
            "\ue205л\ue205",
            "",
            "01/006a10",
            "тѣмь л\ue205",
            "тѣмь л\ue205 в\ue205д\ue205мо",
            "л\ue205",
            "тѣмь л\ue205",
            "",
            "",
            "κἂν",
            "καί & ἀν",
            "κἄν",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04",
        ],
    ]
    assert _equal(res, expected)

    group = [
        [
            "",
            "",
            "",
            "1/6a10",
            "тѣмь",
            "тѣмь л\ue205 в\ue205д\ue205мо",
            "тѣмь",
            "тѣмь л\ue205",
            "",
            "",
            "κἂν",
            "καί",
            "κἄν",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04",
        ],
        [
            "\ue205л\ue205 WH",
            "\ue205л\ue205",
            "",
            "1/6a10",
            "л\ue205",
            "тѣмь л\ue205 в\ue205д\ue205мо",
            "л\ue205",
            "",
            "",
            "",
            "",
            "ἀν",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04",
        ],
    ]
    res = _close(group, gr_sem, sl_sem)
    expected = [
        [
            "\ue205л\ue205 WH",
            "\ue205л\ue205",
            "",
            "01/006a10",
            "тѣмь л\ue205",
            "тѣмь л\ue205 в\ue205д\ue205мо",
            "тѣмь & л\ue205",
            "тѣмь л\ue205",
            "",
            "",
            "κἂν",
            "καί",
            "κἄν",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04",
        ],
        [
            "\ue205л\ue205 WH",
            "\ue205л\ue205",
            "",
            "01/006a10",
            "тѣмь л\ue205",
            "тѣмь л\ue205 в\ue205д\ue205мо",
            "тѣмь & л\ue205",
            "тѣмь л\ue205",
            "",
            "",
            "κἂν",
            "ἀν",
            "κἄν",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "hl04",
        ],
    ]
    assert _equal(res, expected)
